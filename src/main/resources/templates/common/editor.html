<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.thymeleaf.org" layout:decorate="~{common/layout/layout}">

<head>
<!-- (start) private script -->
<th:block layout:fragment="css">
	<link rel="stylesheet" href="/extensions/tinymce/tinymce.css">
	<script src="/extensions/tinymce/tinymce.min.js"></script>
	<script src="/js/pages/tinymce.js"></script>
	<script src="/extensions/tinymce/initTinymce.js"></script>
	<script src="/extensions/dropzone/dropzone.js"></script>
	<link rel="stylesheet" href="/extensions/dropzone/dropzone.min.css" type="text/css" />
</th:block>
<!-- (end) private script -->
</head>

<body>
	<div layout:fragment="contents">
		<div id="main-content">
			<div class="page-heading">
				<h2>
					<i class="bi bi-bell-fill"></i> 공지사항
				</h2>

				<br> <input class="form-control" type="text" placeholder="제목" aria-label="default input example" id="title"> <br>

		        <div style="display: flex; align-items: center; gap: 1rem;">
		            <h6 style="margin: 0;">카테고리</h6>
		            <div class="form-check" style="margin: 0;">
		                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1" value="IT">
		                <label class="form-check-label" for="flexRadioDefault1"> IT </label>
		            </div>
		            <div class="form-check" style="margin: 0;">
		                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault2" value="인사" checked>
		                <label class="form-check-label" for="flexRadioDefault2"> 인사 </label>
		            </div>
		        </div>


				<textarea name="open" id="open" cols="30" rows="10"></textarea>


				<!-- 
				<form id="form" method="post">
					<input type="file" id="boardFile" name="boardFile" multiple><br>
				</form>
				 -->
				<!--
				<div class="dropzone" id="my-awesome-dropzone"></div>
				-->
				<br>
				<div id="dropzone">
					<!-- 파일첨부 BOX 영역 -->
					<div class="dropzone" id="my-awesome-dropzone">
						<!-- 파일첨부 리스트 영역 -->
						<ul class="list-unstyled mb-3" id="dropzone-preview">
							<li class="mt-2 p-2" id="dropzone-preview-list">
								<!-- This is used as the file preview template -->
								<div class="border rounded-3">
									<div class="d-flex align-items-center p-2">
										<!-- 
										<div class="flex-shrink-0 me-3">
											<div class="width-8 h-auto rounded-3">
												<img data-dz-thumbnail="data-dz-thumbnail" class="w-full h-auto rounded-3 block" src="#" alt="Dropzone-Image" style="width: 120px;" />
											</div>
										</div>
									 -->
										<div class="col-9">
											<div class="flex-grow-1">
												<div class="pt-1">
													<h6 class="font-semibold mb-1" data-dz-name="data-dz-name">&nbsp;</h6>
													<p class="text-sm text-muted fw-normal" data-dz-size="data-dz-size"></p>
													<strong class="error text-danger" data-dz-errormessage="data-dz-errormessage"></strong>
												</div>
											</div>
										</div>
										<div class="col-3 d-flex justify-content-end">
											<div class="shrink-0 ms-3">
												<button data-dz-remove="data-dz-remove" class="btn btn-sm btn-danger">삭제</button>
											</div>
										</div>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>

				<div class="d-flex gap-2 flex-row-reverse">
					<button class="btn btn-primary mt-3" type="submit" id="submit" onclick="save2()">등록</button>
					<a class="btn btn-secondary mt-3" type="submit" id="list" th:href="@{/board/list}">목록</a>
				</div>
				<br>
			</div>
		</div>
	</div>

	<!-- (start) private script -->
	<th:block layout:fragment="script">
		<script th:inline="javascript">
		
	    // Disable AutoDiscover
	    Dropzone.autoDiscover = false;
	    
	    var dropzonePreviewNode = document.querySelector('#dropzone-preview-list'); // <li class="mt-2" id="dropzone-preview-list"> 부분을 가져와서
	    dropzonePreviewNode.id = ''; // 중복 회피를 위해 id 없애고
	    var previewTemplate = dropzonePreviewNode.parentNode.innerHTML; // 엘리먼트 전체를 저장 (템플릿)
	    dropzonePreviewNode.parentNode.removeChild(dropzonePreviewNode); // 그리고 삭제
	    
	    // Set Dropzone Options
	    Dropzone.options.myAwesomeDropzone = {
	        autoProcessQueue: false,
	        uploadMultiple: true,
	        parallelUploads: 20,
	        maxFiles: 20,
	        //addRemoveLinks: true,
	        acceptedFiles: "image/*,application/pdf",
	        maxFilesize: 10,
	        dictDefaultMessage: "파일을 끌어다 놓거나,<br>클릭해서 직접 업로드하세요.<br>(이미지 or PDF / 최대 10개)",
	        
	        previewTemplate: previewTemplate, // 만일 기본 테마를 사용하지않고 커스텀 업로드 테마를 사용하고 싶다면
	        previewsContainer: '#dropzone-preview', // 드롭존 파일 나타나는 영역을 .dropzone이 아닌 다른 엘리먼트에서 하고싶을때
	        
	        clickable: "#dropzone",
	    }
	    
	    // Initialize Dropzone
	    var myDropzone = new Dropzone("#my-awesome-dropzone", {url: "/store-item"});
	    
		const save2 = () => {
	    let header = $("meta[name='_csrf_header']").attr('content');
	    let token = $("meta[name='_csrf']").attr('content');
	    let seqId = /*[[${board.seqId}]]*/ "seqId";
		let formData = new FormData();
		let files = myDropzone.getQueuedFiles();
		console.log(files.length);
		for (const file of files) {
			  formData.append('boardFile', file);
			  console.log(file);
		}
		formData.append("boardTitle", document.getElementById("title").value)
		formData.append("boardContents", tinymce.get("open").getContent())
		formData.append("category", document.querySelector('input[name="flexRadioDefault"]:checked').value)
		
		
		Swal.fire({
		    title: "등록",
		    html: "등록 하시겠습니까?",
		    icon: "info",
		    showCancelButton: true,
		    confirmButtonText: "등록",
		    confirmButtonColor: "#3085d6",
		    cancelButtonText: "취소",
		    cancelButtonColor: "#d33",
		    showLoaderOnConfirm: true,
		    preConfirm: async () => {},
		    allowOutsideClick: () => !Swal.isLoading()
		}).then((result) => {
		    if (result.isConfirmed) {       
		        $.ajax({
		            type: "post",
		            url: "/board/save",
		            processData: false,
		            contentType: false,
		            data: formData,
		            // CSRF Token
		            beforeSend: function (xhr) {
		                xhr.setRequestHeader(header, token);
		            },      
					success: function(data) {
						Swal.fire({
							title: "등록 완료",
							text: "게시글이 등록되었습니다.",
							icon: "success"
						}).then(() => {
							// URL 검증 로직 추가 (2024-06-22 CWE-601 Open Redirect)
							const allowedPattern = /^\/board\/\d+$/; // "/board/숫자" 형식의 URL을 허용하는 정규 표현식
							const redirectUrl = data;

							try {
								const url = new URL(redirectUrl, window.location.origin);
								if (allowedPattern.test(url.pathname)) {
									// Sanitize the URL by encoding potential unsafe characters
									const sanitizedPath = encodeURI(url.pathname);
									window.location.href = sanitizedPath;
								} else {
									console.error('Redirect URL is not allowed:', redirectUrl);
									Swal.fire({
										title: "오류",
										text: "잘못된 리디렉션 URL입니다.",
										icon: "error"
									});
								}
							} catch (e) {
								console.error('Invalid URL:', redirectUrl);
								Swal.fire({
									title: "오류",
									text: "잘못된 URL입니다.",
									icon: "error"
								});
							}
						});
					},

		            error: function(xhr, status, error) {
		                Swal.fire({
		                    title: "등록 실패",
		                    text: "게시글 등록에 실패했습니다.",
		                    icon: "error"
		                });
		            }
		        });
		    }
		});
		}
		
	    </script>
	</th:block>
	<!-- (end) private script -->

</body>

</html>