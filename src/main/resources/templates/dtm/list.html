<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.thymeleaf.org" layout:decorate="~{common/layout/layout}">

<head>
	<!-- (start) private script -->
	<th:block layout:fragment="css">
		<link rel="stylesheet" href="/extensions/litepicker/litepicker.css"/>
		<style>
			.pagination .page-item {
				margin: 0 2px; /* 좌우 마진을 동일하게 설정 */
			}

			.pagination .page-item .page-link {
				padding: 7px 10px; /* 버튼 크기를 조정 */
			}
		</style>
	</th:block>
	<!-- (end) private script -->
</head>

<body>
<div layout:fragment="contents">
	<div class="container">
		<div id="main-content">
			<div class="d-flex justify-content-center">
				<div class="row col-lg-10 col-md-12 d-flex justify-content-center">
					<div class="page-heading">
						<div class="align-middle">
							<h2>
								<i class="bi bi-bell-fill"></i> 근태내역
							</h2>
							<br>
						</div>
					</div>
					<p class="d-inline-flex gap-1">
						<button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#collapseSearch" aria-expanded="false" aria-controls="collapseSearch">
							<i class="bi bi-search"></i>
							검색
						</button>
						<select id="itemsPerPage" class="form-select form-select-sm ms-2 w-auto" aria-label="Items per page">
							<option value="5" selected>5개</option>
							<option value="10">10개</option>
							<option value="20">20개</option>
							<option value="50">50개</option>
						</select>
					</p>
					<div class="collapse" id="collapseSearch">
						<div class="card card-body">
							<div class="card-body p-3">
								<div class="d-flex align-items-center justify-content-between mb-2">
									<h6>결재상태</h6>
									<div class="btn-group btn-group-sm" role="group" aria-label="Basic radio toggle button group">
										<input type="checkbox" class="btn-check" name="statCdList" id="121" autocomplete="off" checked>
										<label class="btn btn-outline-primary" for="121">결재중</label>

										<input type="checkbox" class="btn-check" name="statCdList" id="132" autocomplete="off" checked>
										<label class="btn btn-outline-primary" for="132">결재완료</label>

										<input type="checkbox" class="btn-check" name="statCdList" id="131" autocomplete="off" checked>
										<label class="btn btn-outline-primary" for="131">반려</label>
									</div>
								</div>
							</div>

							<div class="card-body p-3">
								<div class="d-flex align-items-center justify-content-between mb-2">
									<h6>근태종류</h6>
									<div class="btn-group btn-group-sm" role="group" aria-label="Basic radio toggle button group">
										<input type="radio" class="btn-check" name="dtmKindNm" id="dtmKindNm" autocomplete="off" checked>
										<label class="btn btn-outline-primary" for="dtmKindNm">전체</label>

										<input type="radio" class="btn-check" name="dtmKindNm" id="dtmKindNm1" autocomplete="off">
										<label class="btn btn-outline-primary" for="dtmKindNm1">연차</label>

										<input type="radio" class="btn-check" name="dtmKindNm" id="dtmKindNm2" autocomplete="off">
										<label class="btn btn-outline-primary" for="dtmKindNm2">저축</label>

										<input type="radio" class="btn-check" name="dtmKindNm" id="dtmKindNm3" autocomplete="off">
										<label class="btn btn-outline-primary" for="dtmKindNm3">보상</label>
									</div>
								</div>
								<select class="form-select" aria-label="Default select example" name="dtmKindNmSelect" id="dtmDetail">
									<option value="" selected>전체</option>
									<option value="DTM01">연차휴가</option>
									<option value="DTM02">연차휴가 오전(반차)</option>
									<option value="DTM03">연차휴가 오전(반반차)</option>
									<option value="DTM04">연차휴가 오후(반차)</option>
									<option value="DTM05">연차휴가 오후(반반차)</option>
									<option value="DTM06">저축휴가</option>
									<option value="DTM07">저축휴가 오전(반차)</option>
									<option value="DTM08">저축휴가 오전(반반차)</option>
									<option value="DTM09">저축휴가 오후(반차)</option>
									<option value="DTM10">저축휴가 오후(반반차)</option>
								</select>
							</div>

							<div class="card-body p-3">
								<h6>근태기간</h6>
								<div class="d-flex align-items-center justify-content-between mb-2">
									<input type="text" class="form-control me-1 start-input" name="start-input" id="start-input" placeholder="YYYY-MM-DD">
									<span>~</span>
									<input type="text" class="form-control ms-1 end-input" name="end-input" id="end-input" placeholder="YYYY-MM-DD">
								</div>
								<div class="d-flex justify-content-center">
									<input type="text" class="form-control start-date" id="start-date" style="display: none;">
									<input type="text" class="form-control end-date" id="end-date" style="display: none;">
								</div>
							</div>

							<div class="d-flex flex-wrap gap-2 justify-content-end align-items-center mb-3">
								<button class="btn btn-primary btn-sm" id="search-button">조회</button>
								<button class="btn btn-primary btn-sm" id="reset-button">초기화</button>
							</div>
						</div>
					</div>

					<!--컨텐츠 목록-->
					<div id="dtmListContainer">
						<div class="row col-lg-12 col-md-12 col-sm-12">
							<div class="col-12">
								<div class="animate__animated animate__fadeIn animate__slow">
									<section class="section" th:each="dtm: ${dtmHis}">
										<div class="card">
											<div class="card-body">
												<div th:switch="${dtm.status}">
                                                    <span th:case="'과거'" class="badge badge-sm mb-4 bg-secondary">
                                                        <span th:text="${dtm.status}"></span>
                                                    </span>
													<span th:case="'예정'" class="badge badge-sm mb-4 bg-primary">
                                                        <span th:text="${dtm.status}"></span>
                                                    </span>
													<span th:case="'진행'" class="badge badge-sm mb-4 bg-warning">
                                                        <span th:text="${dtm.status}"></span>
                                                    </span>
												</div>
												<h6><span th:text="${dtm.dtmKindCd}"></span></h6>
												<div class="d-flex flex-row align-items-center mt-3 mb-3 gap-3">
													<div class="d-flex align-items-center gap-2">
														<h6>
															<span th:text="${#temporals.format(dtm.staYmd, 'yyyy-MM-dd')}"> </span>
															~
															<span th:text="${#temporals.format(dtm.endYmd, 'yyyy-MM-dd')}"> </span>
														</h6>
													</div>
												</div>
												<div class="d-flex flex-row mb-3 gap-3">
													<div>
														<i class="bi bi-calendar-check"></i>
														<h7 th:text="${#temporals.format(dtm.tzDate, 'yyyy-MM-dd')}"></h7>
													</div>
													<div>
														<i class="bi bi-lightbulb"></i>
														<h7 th:text="${dtm.statCdNm}"></h7>
													</div>
												</div>
											</div>
										</div>
									</section>
								</div>
							</div>
						</div>

						<!-- 페이징처리 시작 -->
						<div th:if="${!dtmHis.isEmpty()}">
							<ul class="pagination justify-content-center align-items-center">
								<!-- Previous button -->
								<li class="page-item" th:classappend="${startPage == 1} ? 'disabled'">
									<a class="page-link" th:href="@{|?page=${startPage - 1}|}" th:if="${startPage > 1}">
										<span><i class="bi bi-caret-left-fill"></i></span>
									</a>
								</li>
								<!-- Page numbers -->
								<li th:each="page : ${#numbers.sequence(startPage, endPage)}"
									th:classappend="${page == dtmHis.number + 1} ? 'active'" class="page-item mx-1">
									<a th:text="${page}" class="page-link" th:href="@{|?page=${page}|}"></a>
								</li>
								<!-- Next button -->
								<li class="page-item" th:classappend="${endPage == dtmHis.totalPages} ? 'disabled'" th:if="${endPage < dtmHis.totalPages}">
									<a class="page-link" th:href="@{|?page=${endPage + 1}|}">
										<span><i class="bi bi-caret-right-fill"></i></span>
									</a>
								</li>
							</ul>
						</div>
						<!-- 페이징처리 끝 -->
					</div>

				</div>
			</div>
		</div>
	</div>
</div>

<!-- (start) private script -->
<th:block layout:fragment="script">
	<script src="/extensions/litepicker/bundle.js"></script>
	<script src="/extensions/litepicker/mobilefriendly.js"></script>
	<script>
		// 검색 폼 관련 스크립트

		// 날짜 입력폼 이벤트 발생 시
		document.addEventListener('input', function(event) {
			if (event.target.classList.contains('start-input')) {
				handleDateInput(event);
			} else if (event.target.classList.contains('end-input')) {
				handleDateInput(event);
			}
		});

		// 날짜 입력값 검증
		const handleDateInput = (event) => {
			const input = event.target;
			const value = input.value;
			const validChars = /^[0-9-]*$/;

			// 숫자 또는 하이픈(-)만 입력 허용
			if (!validChars.test(value)) {
				// Remove invalid characters
				input.value = value.replace(/[^0-9-]/g, '');
			}

			if (value && !isValidDate(input.value)) {
				input.setCustomValidity('Please enter a valid date in YYYY-MM-DD format');
			} else {
				input.setCustomValidity('');
			}
		}

		// 날짜 입력 형식 검증
		const isValidDate = (dateString) => {
			const regex = /^\d{4}-\d{2}-\d{2}$/;
			if (!dateString.match(regex)) {
				return false;
			}

			const date = new Date(dateString);
			const timestamp = date.getTime();

			if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) return false;
			return dateString === date.toISOString().split('T')[0];
		}




		// 달력 생성 함수
		const initializePicker = (staYmdInput, endYmdInput) => {
			const picker = new Litepicker({
				element: staYmdInput,
				elementEnd: endYmdInput,
				switchingMonths: true,
				singleMode: false,
				allowRepick: false,
				autoApply: false,
				autoRefresh: true,
				inlineMode: false,
				resetButton: true,
				lang: 'ko-KR',
				buttonText: { "apply": "적용", "cancel": "취소"},
				dropdowns: { "minYear": 2023, "maxYear": null, "months": false, "years": false },
				format: 'YYYY-MM-DD',
				setup: (picker) => {
					picker.on('selected', (date1, date2) => {
						staYmdInput.value = date1.format('YYYY-MM-DD');
						endYmdInput.value = date2.format('YYYY-MM-DD');
					})
				}
			});

			// 날짜 지정 시 Form에 값 설정
			const updatePicker = () => {
				const startDateValue = staYmdInput.value;
				const endDateValue = endYmdInput.value;
				if (startDateValue && endDateValue) {
					picker.setDateRange(startDateValue, endDateValue);
				}
			}

			staYmdInput.addEventListener('change', updatePicker);
			endYmdInput.addEventListener('change', updatePicker);

			// 1년 전 날짜 설정
			const oneYear = new Date();
			oneYear.setFullYear(oneYear.getFullYear() - 1);
			const lastYear = oneYear.toISOString().split('T')[0];
			staYmdInput.value = lastYear;

			// 오늘 날짜 설정
			const today = new Date().toISOString().split('T')[0];
			endYmdInput.value = today;

			// 달력 날짜 설정 (1년전 ~ 오늘)
			picker.setDateRange(lastYear, today);
		}

		// 화면 로드 시 달력 초기화
		$(function () {
			// Input Form 입력값을 가져와서 달력 초기화
			const staYmdInput = document.getElementById('start-input');
			const endYmdInput = document.getElementById('end-input');
			initializePicker(staYmdInput, endYmdInput);
		});







		// 페이지네이션 링크 주소 업데이트
		const updatePaginationLinks = () => {
			// 폼의 값 가져오기
			let statCdList = [];
			$('input[name="statCdList"]:checked').each(function() {
				statCdList.push($(this).attr('id'));
			});
			let dtmKindNm = $('#dtmDetail option:selected').val();
			let staYmdInput = $('#start-input').val();
			let endYmdInput = $('#end-input').val();
			let itemsPerPage = $('#itemsPerPage').val();

			// 페이지네이션 링크 업데이트
			$('.page-link').each(function() {
				let baseUrl = $(this).attr('href').split('?')[0];
				let newUrl = `${baseUrl}?page=${$(this).text()}&statCdList=${statCdList.join(',')}&dtmKindNm=${dtmKindNm}&staYmdInput=${staYmdInput}&endYmdInput=${endYmdInput}&itemsPerPage=${itemsPerPage}`;
				$(this).attr('href', newUrl);
			});
		}

		// 페이지네이션 버튼 클릭 시 전체화면을 reload 하지 않도록 비동기 처리
		$(document).on('click', '.page-link', function(event) {
			event.preventDefault();
			let url = $(this).attr('href');
			$.get(url, function(data) {
				$('#dtmListContainer').html($(data).find('#dtmListContainer').html());
				updatePaginationLinks(); // 페이지 업데이트 후 다시 링크 업데이트
			});
		});

		// 조회 버튼 클릭 시
		$('#search-button').on('click', function() {
			search();
		});

		// 초기화 버튼 클릭 시 폼 초기화 후 목록 갱신
		$('#reset-button').on('click', function() {
			$('input[name="statCdList"]').prop('checked', true); // 모든 체크박스 체크
			$('input[name="dtmKindNm"]').prop('checked', false); // 모든 라디오버튼 해제
			$('#dtmKindNm').prop('checked', true); // '전체' 라디오버튼 체크
			$('#dtmDetail').val(''); // 셀렉트박스 초기화
			$('#itemsPerPage').val('5'); // 페이지네이션 갯수 초기화

			// 시작 날짜 초기화
			const oneYear = new Date();
			oneYear.setFullYear(oneYear.getFullYear() - 1);
			const lastYear = oneYear.toISOString().split('T')[0];
			$('#start-input').val(lastYear); // 시작 날짜 초기화

			// 종료 날짜 초기화
			const today = new Date().toISOString().split('T')[0];
			$('#end-input').val(today);

			search(); // 목록 갱신
		});

		// itemsPerPage Select Box 선택 시 목록 갱신
		$('#itemsPerPage').on('change', function() {
			search();
		});

		// 목록 갱신 함수
		const search = () => {
			let statCdList = [];
			$('input[name="statCdList"]:checked').each(function() {
				statCdList.push($(this).attr('id'));
			});
			let dtmKindNm = $('#dtmDetail option:selected').val();
			let staYmdInput = $('#start-input').val();
			let endYmdInput = $('#end-input').val();
			let itemsPerPage = $('#itemsPerPage').val();

			// 검색 조건에 맞는 데이터 조회
			$.get(`/dtm/list?statCdList=${statCdList.join(',')}&dtmKindNm=${dtmKindNm}&staYmdInput=${staYmdInput}&endYmdInput=${endYmdInput}&itemsPerPage=${itemsPerPage}`, function(data) {
				$('#dtmListContainer').html($(data).find('#dtmListContainer').html());
				updatePaginationLinks(); // 페이지 업데이트 후 다시 링크 업데이트
				$('#collapseSearch').collapse('hide'); // 검색 폼 접기
			});
		}
	</script>
</th:block>
<!-- (end) private script -->
</body>

</html>
